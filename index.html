<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>~/home</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap");

      :root {
        --bg-color: #0f172a;
        --text-color: #e2e8f0;
        --accent-color: #38bdf8;
        --dim-color: #475569;
        --card-bg: #1e293b;
        --border-color: #334155;
        --cursor-color: #38bdf8;
        --success-color: #22c55e;
        --error-color: #ef4444;
        --selection-bg: rgba(56, 189, 248, 0.3);
      }

      /* Reset & Base */
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        background-color: var(--bg-color);
        color: var(--text-color);
        font-family: monospace;
        transition: background-color 0.3s, color 0.3s;
        height: 100vh;
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        overflow: hidden;
      }

      ::selection {
        background: var(--selection-bg);
      }

      /* Themes */
      .theme-dracula {
        --bg-color: #282a36;
        --text-color: #f8f8f2;
        --accent-color: #ff79c6;
        --dim-color: #6272a4;
        --card-bg: #44475a;
        --border-color: #6272a4;
        --cursor-color: #50fa7b;
        --selection-bg: rgba(255, 121, 198, 0.3);
      }

      .theme-gruvbox {
        --bg-color: #282828;
        --text-color: #ebdbb2;
        --accent-color: #d79921;
        --dim-color: #928374;
        --card-bg: #3c3836;
        --border-color: #504945;
        --cursor-color: #ebdbb2;
        --selection-bg: rgba(215, 153, 33, 0.3);
      }

      .theme-matrix {
        --bg-color: #000000;
        --text-color: #00ff00;
        --accent-color: #00ff00;
        --dim-color: #003300;
        --card-bg: #0a0a0a;
        --border-color: #003300;
        --cursor-color: #00ff00;
        --selection-bg: rgba(0, 255, 0, 0.2);
      }

      .theme-catppuccin {
        --bg-color: #1e1e2e;
        --text-color: #cdd6f4;
        --accent-color: #cba6f7;
        --dim-color: #a6adc8;
        --card-bg: #313244;
        --border-color: #45475a;
        --cursor-color: #cba6f7;
        --selection-bg: rgba(203, 166, 247, 0.3);
      }

      .theme-eink {
        --bg-color: #ffffff;
        --text-color: #000000;
        --accent-color: #000000;
        --dim-color: #666666;
        --card-bg: #ffffff;
        --border-color: #000000;
        --cursor-color: #000000;
        --selection-bg: rgba(0, 0, 0, 0.1);
      }

      /* Utilities */
      .hidden {
        display: none !important;
      }
      .text-accent {
        color: var(--accent-color);
      }
      .text-dim {
        color: var(--dim-color);
      }
      .text-error {
        color: var(--error-color);
      }

      /* Top Bar */
      .top-bar {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        padding: 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        font-size: 0.875rem;
        z-index: 40;
      }

      .weather-container {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        opacity: 0.7;
        transition: opacity 0.2s;
        cursor: pointer;
      }
      .weather-container:hover {
        opacity: 1;
      }

      .theme-switcher {
        display: flex;
        gap: 1rem;
        opacity: 0.5;
        transition: opacity 0.2s;
        flex-wrap: wrap;
        justify-content: flex-end;
      }
      .theme-switcher:hover {
        opacity: 1;
      }
      .theme-btn {
        background: none;
        border: none;
        color: inherit;
        font-family: inherit;
        cursor: pointer;
        padding: 0;
      }
      .theme-btn:hover,
      .theme-btn:focus {
        color: var(--accent-color);
        outline: none;
      }

      /* Main Layout */
      .main-container {
        width: 100%;
        max-width: 72rem;
        padding: 0 1.5rem;
        display: flex;
        gap: 2rem;
        height: 80vh;
        align-items: center;
      }

      /* Left Column */
      .left-col {
        width: 33.33%;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        padding-top: 3rem;
        padding-bottom: 3rem;
      }

      /* Clock */
      .clock-section mb-4 {
        margin-bottom: 1rem;
      }
      #date-display {
        font-size: 1.125rem;
        color: var(--dim-color);
        margin-bottom: 0.5rem;
      }
      #clock-display {
        font-family: "JetBrains Mono", monospace;
        font-size: 3.75rem;
        font-weight: 700;
        line-height: 1;
        letter-spacing: -0.05em;
        margin-bottom: 1rem;
      }
      .greeting {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
      }

      /* Tasks */
      .tasks-section {
        flex: 1;
        margin-top: 3rem;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }
      .task-list {
        overflow-y: auto;
        padding-right: 0.5rem;
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }
      .task-item {
        border-left: 2px solid var(--dim-color);
        padding-left: 0.75rem;
        padding-top: 0.25rem;
        padding-bottom: 0.25rem;
        transition: all 0.2s;
        display: flex;
        justify-content: space-between;
        font-size: 0.875rem;
        position: relative;
      }
      .task-item:hover {
        border-left-color: var(--accent-color);
        background: rgba(255, 255, 255, 0.05);
      }
      .task-item.priority-high {
        border-left-color: var(--error-color) !important;
      }

      .task-text {
        color: var(--dim-color);
        cursor: default;
      }
      .task-item:hover .task-text {
        color: var(--text-color);
      }
      .task-item.priority-high .task-text {
        color: var(--text-color);
      }

      .task-close {
        color: var(--dim-color);
        font-size: 0.75rem;
        opacity: 0;
        cursor: pointer;
      }
      .task-close:hover {
        color: var(--error-color);
      }
      .task-item:hover .task-close {
        opacity: 1;
      }

      /* Right Column */
      .right-col {
        width: 66.66%;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      /* Search */
      .search-container {
        margin-bottom: 2.5rem;
        position: relative;
      }
      .search-box {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        background: var(--card-bg);
        padding: 1rem;
        border-radius: 0.25rem;
        border: 2px solid var(--border-color);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        transition: border-color 0.2s;
      }
      .search-box:focus-within {
        border-color: var(--accent-color);
      }
      .search-prompt {
        font-weight: bold;
        color: var(--accent-color);
      }
      .search-input {
        background: transparent;
        border: none;
        color: var(--text-color);
        caret-color: var(--cursor-color);
        outline: none;
        width: 100%;
        font-size: 1.25rem;
        font-family: inherit;
      }
      .search-help {
        position: absolute;
        bottom: -2rem;
        left: 0;
        font-size: 0.75rem;
        color: var(--dim-color);
        opacity: 0;
        transition: opacity 0.2s;
      }
      .search-box:focus-within + .search-help {
        opacity: 1;
      }

      /* Grid */
      .links-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1.5rem;
      }
      .col-span-3 {
        grid-column: span 3;
      }

      /* Categories */
      .category-title {
        color: var(--dim-color);
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        margin-bottom: 0.75rem;
        border-bottom: 2px solid var(--border-color);
        padding-bottom: 0.25rem;
        display: flex;
        justify-content: space-between;
      }
      .category-list {
        list-style: none;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        font-size: 0.875rem;
      }
      .category-list a {
        color: var(--dim-color);
        text-decoration: none;
        transition: color 0.2s;
        display: block;
      }
      .category-list a:hover {
        color: var(--text-color);
      }

      /* Fav Box Special */
      .fav-box {
        grid-column: span 1;
        grid-row: span 2;
        border: 1px solid rgba(56, 189, 248, 0.3); /* fallback */
        border-color: color-mix(in srgb, var(--accent-color), transparent 70%);
        padding: 1rem;
        border-radius: 0.25rem;
        background: color-mix(in srgb, var(--card-bg), transparent 50%);
        position: relative;
      }
      .fav-box .category-title {
        color: var(--accent-color);
      }
      .fav-link {
        display: flex;
        justify-content: space-between;
        color: var(--text-color) !important;
      }
      .fav-link:hover {
        color: var(--accent-color) !important;
      }
      .fav-key {
        color: var(--dim-color);
        font-size: 0.75rem;
        opacity: 0.5;
      }
      .fav-link:hover .fav-key {
        opacity: 1;
      }
      .fav-icon {
        position: absolute;
        bottom: 0.5rem;
        right: 0.5rem;
        opacity: 0.1;
        transition: opacity 0.2s;
      }
      .fav-box:hover .fav-icon {
        opacity: 0.5;
      }

      /* Footer */
      .footer-info {
        border-top: 1px solid var(--border-color);
        padding-top: 1rem;
        margin-top: 0.5rem;
        display: flex;
        justify-content: space-between;
        font-size: 0.75rem;
        color: var(--dim-color);
      }

      /* Toast */
      #toast {
        position: fixed;
        top: 1.5rem;
        left: 50%;
        transform: translateX(-50%);
        padding: 0.5rem 1rem;
        border-radius: 0.25rem;
        border: 2px solid var(--accent-color);
        background: var(--bg-color);
        color: var(--accent-color);
        font-size: 0.875rem;
        z-index: 50;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
      }
      #toast.show {
        opacity: 1;
      }

      /* Modal/Overlay */
      #help-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(4px);
        z-index: 100;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
      }
      .modal-content {
        background: var(--card-bg);
        border: 2px solid var(--accent-color);
        padding: 2rem;
        max-width: 48rem;
        width: 100%;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        border-radius: 0.5rem;
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 1.5rem;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 1rem;
      }
      .modal-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 2rem;
        font-size: 0.875rem;
      }
      @media (min-width: 768px) {
        .modal-grid {
          grid-template-columns: 1fr 1fr;
        }
      }

      .help-cmd-list {
        list-style: none;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        color: var(--dim-color);
      }
      .help-cmd-list span {
        color: var(--accent-color);
      }
      .help-grid-cmds {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
        color: var(--dim-color);
      }

      /* Focus Accessibility */
      :focus-visible {
        outline: none;
        outline-offset: 4px;
        border-radius: 2px;
      }

      /* Scrollbar */
      ::-webkit-scrollbar {
        width: 6px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: var(--dim-color);
        border-radius: 3px;
      }

      @media (max-width: 768px) {
        .main-container {
          flex-direction: column;
          height: auto;
          padding: 6rem 1.5rem;
        }
        .left-col,
        .right-col {
          width: 100%;
          padding: 0;
        }
        .links-grid {
          grid-template-columns: repeat(2, 1fr);
        }
        .col-span-3 {
          grid-column: span 2;
        }
        .fav-box {
          grid-column: span 2;
          grid-row: auto;
        }
      }
    </style>
  </head>
  <body>
    <!-- Toast Notification -->
    <div id="toast">System message</div>

    <!-- Help Overlay -->
    <div id="help-overlay" class="hidden" onclick="toggleHelp()">
      <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
          <h2
            style="
              font-size: 1.5rem;
              font-weight: bold;
              color: var(--accent-color);
            "
          >
            ~/manual
          </h2>
          <span style="font-size: 0.75rem; color: var(--dim-color)"
            >[ESC] to close</span
          >
        </div>

        <div class="modal-grid">
          <div>
            <h3
              style="
                color: var(--text-color);
                font-weight: bold;
                margin-bottom: 0.75rem;
                text-transform: uppercase;
                letter-spacing: 0.05em;
              "
            >
              CLI Tools
            </h3>
            <ul class="help-cmd-list">
              <li><span>todo [text] (!high)</span> - Add task</li>
              <li><span>done [index]</span> - Complete task</li>
              <li><span>fav add [name] [url]</span> - Add link</li>
              <li><span>fav rm [index]</span> - Remove link</li>
              <li><span>config loc [lat] [lon]</span> - Set weather</li>
              <li><span>clear</span> - Clear all tasks</li>
            </ul>
          </div>

          <div>
            <h3
              style="
                color: var(--text-color);
                font-weight: bold;
                margin-bottom: 0.75rem;
                text-transform: uppercase;
                letter-spacing: 0.05em;
              "
            >
              Search Prefixes
            </h3>
            <div class="help-grid-cmds">
              <div><span>g</span> Google</div>
              <div><span>gh</span> GitHub</div>
              <div><span>npm</span> NPM</div>
              <div><span>p</span> PyPI</div>
              <div><span>aur</span> ArchWiki</div>
              <div><span>so</span> StackOv.</div>
              <div><span>yt</span> YouTube</div>
              <div><span>d</span> DuckDuckGo</div>
            </div>
          </div>
        </div>

        <div
          class="modal-grid"
          style="
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
          "
        >
          <div>
            <h3
              style="
                color: var(--text-color);
                font-weight: bold;
                margin-bottom: 0.5rem;
                text-transform: uppercase;
                letter-spacing: 0.05em;
              "
            >
              Navigation
            </h3>
            <p style="color: var(--dim-color)">
              Press
              <span
                style="
                  color: var(--accent-color);
                  border: 1px solid var(--dim-color);
                  padding: 0 0.25rem;
                  border-radius: 2px;
                "
                >/</span
              >
              to focus search bar
            </p>
            <p style="color: var(--dim-color); margin-top: 0.25rem">
              Press
              <span
                style="
                  color: var(--accent-color);
                  border: 1px solid var(--dim-color);
                  padding: 0 0.25rem;
                  border-radius: 2px;
                "
                >1-4</span
              >
              to open favourites
            </p>
          </div>
          <div>
            <h3
              style="
                color: var(--text-color);
                font-weight: bold;
                margin-bottom: 0.5rem;
                text-transform: uppercase;
                letter-spacing: 0.05em;
              "
            >
              System
            </h3>
            <p style="color: var(--dim-color)">Theme saves to localStorage.</p>
            <p style="color: var(--dim-color)">Weather polls hourly.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Top Bar -->
    <div class="top-bar">
      <div
        id="weather-container"
        class="weather-container"
        title="Click to refresh force"
      >
        <i data-lucide="cloud" style="width: 1rem; height: 1rem"></i>
        <span id="weather-text">init_sequence...</span>
      </div>

      <div class="theme-switcher">
        <button onclick="setTheme('default')" class="theme-btn">[def]</button>
        <button onclick="setTheme('dracula')" class="theme-btn">[drac]</button>
        <button onclick="setTheme('gruvbox')" class="theme-btn">[gruv]</button>
        <button onclick="setTheme('catppuccin')" class="theme-btn">
          [catp]
        </button>
        <button onclick="setTheme('matrix')" class="theme-btn">[mtx]</button>
        <button onclick="setTheme('eink')" class="theme-btn">[eink]</button>
      </div>
    </div>

    <!-- Main Content -->
    <main class="main-container">
      <!-- Left Column: Clock & Tasks -->
      <div class="left-col">
        <!-- Clock -->
        <div class="clock-section">
          <p id="date-display">Loading...</p>
          <h1 id="clock-display">00:00</h1>
          <div class="greeting">
            <span class="text-dim">$</span>
            <span id="greeting" class="text-accent">awaiting_input</span>
          </div>
        </div>

        <!-- Tasks -->
        <div class="tasks-section">
          <div class="category-title">
            <span>~/tasks</span>
            <span
              class="text-dim"
              style="font-size: 0.75rem; text-transform: lowercase"
              >cmd: todo/done</span
            >
          </div>
          <div id="task-list" class="task-list">
            <!-- Tasks injected here -->
            <div
              class="text-dim"
              style="font-style: italic; padding-left: 0.5rem"
            >
              No active processes...
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column: Search & Links -->
      <div class="right-col">
        <!-- Search Bar -->
        <div class="search-container">
          <div class="search-box">
            <span class="search-prompt">&gt;</span>
            <input
              type="text"
              id="search-input"
              class="search-input"
              placeholder="search or enter 'help'..."
              autocomplete="off"
            />
          </div>
          <div class="search-help">
            <span>Type 'help' for commands</span>
          </div>
        </div>

        <!-- Links Grid -->
        <div class="links-grid">
          <!-- Dynamic Favourites -->
          <div class="fav-box group">
            <div class="category-title">~/favourites</div>
            <ul id="fav-list" class="category-list" style="gap: 0.75rem">
              <!-- Favourites injected here -->
            </ul>
            <div class="fav-icon">
              <i data-lucide="star" style="width: 1.5rem; height: 1.5rem"></i>
            </div>
          </div>

          <!-- Dynamic Dev Links -->
          <div>
            <div class="category-title">~/dev</div>
            <ul id="dev-list" class="category-list"></ul>
          </div>

          <!-- Dynamic Docs Links -->
          <div>
            <div class="category-title">~/docs</div>
            <ul id="docs-list" class="category-list"></ul>
          </div>

          <!-- Dynamic Tools Links -->
          <div>
            <div class="category-title">~/tools</div>
            <ul id="tools-list" class="category-list"></ul>
          </div>

          <!-- Footer Info -->
          <div class="col-span-3 footer-info">
            <span>HOTKEYS: [1-4] Open Favs</span>
            <span>CMD: 'help' for manual</span>
          </div>
        </div>
      </div>
    </main>

    <script>
      lucide.createIcons();

      // --- TOAST SYSTEM ---
      function showToast(msg, duration = 3000) {
        const toast = document.getElementById("toast");
        toast.innerText = msg;
        toast.classList.add("show");
        setTimeout(() => toast.classList.remove("show"), duration);
      }

      // --- HELP OVERLAY ---
      function toggleHelp() {
        const overlay = document.getElementById("help-overlay");
        overlay.classList.toggle("hidden");
      }

      // --- DATA PERSISTENCE HELPER ---
      const DB = {
        get: (key, defaultVal) =>
          JSON.parse(localStorage.getItem(key)) || defaultVal,
        set: (key, val) => localStorage.setItem(key, JSON.stringify(val)),
      };

      // --- STATE MANAGEMENT ---
      let state = {
        favs: DB.get("devStartFavs", [
          { name: "YouTube", url: "https://youtube.com" },
          { name: "Reddit", url: "https://reddit.com" },
          { name: "Gemini", url: "https://gemini.google.com" },
          { name: "Proton", url: "https://proton.me" },
        ]),
        tasks: DB.get("devStartTasks", []),
        location: DB.get("devStartLoc", null),
        theme: localStorage.getItem("devStartTheme") || "default",
        weather: DB.get("devStartWeather", { data: null, lastFetch: 0 }),
        // New Dynamic Categories with Defaults
        dev: DB.get("devStartLinksDev", [
          { name: "localhost:3000", url: "http://localhost:3000" },
          { name: "github", url: "https://github.com" },
          { name: "gitlab", url: "https://gitlab.com" },
        ]),
        docs: DB.get("devStartLinksDocs", [
          { name: "MDN Docs", url: "https://developer.mozilla.org/en-US/" },
          { name: "PyPI", url: "https://pypi.org/" },
          { name: "StackOverflow", url: "https://stackoverflow.com/" },
        ]),
        tools: DB.get("devStartLinksTools", [
          { name: "ChatGPT", url: "https://chatgpt.com/" },
          { name: "Regex101", url: "https://regex101.com/" },
          {
            name: "JSON Lint",
            url: "https://jsonformatter.curiousconcept.com/",
          },
        ]),
      };
      // --- INIT: PERSIST DEFAULTS ---
      // Ensure these keys exist in localStorage immediately so they can be edited manually
      if (!localStorage.getItem("devStartLinksDev"))
        DB.set("devStartLinksDev", state.dev);
      if (!localStorage.getItem("devStartLinksDocs"))
        DB.set("devStartLinksDocs", state.docs);
      if (!localStorage.getItem("devStartLinksTools"))
        DB.set("devStartLinksTools", state.tools);
      if (!localStorage.getItem("devStartFavs"))
        DB.set("devStartFavs", state.favs);

      // --- RENDERING ---

      function renderFavourites() {
        const list = document.getElementById("fav-list");
        list.innerHTML = state.favs
          .map(
            (fav, i) => `
                <li>
                    <a href="${fav.url}" class="fav-link">
                        <span>${fav.name}</span>
                        <span class="fav-key">[${i + 1}]</span>
                    </a>
                </li>
            `
          )
          .join("");
      }

      // Generic helper for non-fav lists
      function renderCategoryList(elementId, items) {
        const list = document.getElementById(elementId);
        list.innerHTML = items
          .map(
            (item) => `
                <li><a href="${item.url}" target="_blank">${item.name}</a></li>
            `
          )
          .join("");
      }

      function renderTasks() {
        const list = document.getElementById("task-list");
        if (state.tasks.length === 0) {
          list.innerHTML =
            '<div class="text-dim" style="font-style: italic; padding-left: 0.5rem;">No active processes...</div>';
          return;
        }
        list.innerHTML = state.tasks
          .map(
            (task, i) => `
                <div class="task-item ${
                  task.priority === "high" ? "priority-high" : ""
                }">
                    <span class="task-text">${task.text}</span>
                    <span class="task-close" onclick="removeTask(${i})">[x]</span>
                </div>
            `
          )
          .join("");
      }

      function removeTask(index) {
        state.tasks.splice(index, 1);
        DB.set("devStartTasks", state.tasks);
        renderTasks();
      }

      // --- CORE FEATURES ---

      // Weather (With 1-hour caching)
      async function updateWeather(force = false) {
        const el = document.getElementById("weather-text");

        const CACHE_DURATION = 3600 * 1000; // 1 hour in ms
        const now = Date.now();

        // 1. Use Cache if valid and not forced
        if (
          !force &&
          state.weather.data &&
          now - state.weather.lastFetch < CACHE_DURATION
        ) {
          const temp = Math.round(
            state.weather.data.current_weather.temperature
          );
          el.innerText = `${temp}°C (cached)`;
          return;
        }

        // 2. Determine Location
        let lat, lon;
        if (state.location) {
          lat = state.location.lat;
          lon = state.location.lon;
        } else {
          if (!navigator.geolocation) {
            el.innerText = "No_Geo_API";
            return;
          }
          try {
            const pos = await new Promise((res, rej) =>
              navigator.geolocation.getCurrentPosition(res, rej)
            );
            lat = pos.coords.latitude;
            lon = pos.coords.longitude;
          } catch (e) {
            el.innerText = "Loc_Denied";
            return;
          }
        }

        // 3. Fetch Fresh Data
        try {
          el.innerText = "fetching...";
          const res = await fetch(
            `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`
          );
          const data = await res.json();

          // Update State & LocalStorage
          state.weather = { data: data, lastFetch: now };
          DB.set("devStartWeather", state.weather);

          const temp = Math.round(data.current_weather.temperature);
          el.innerText = `${temp}°C`;
        } catch (e) {
          el.innerText = "Net_Error";
        }
      }

      // Allow manual refresh
      document
        .getElementById("weather-container")
        .addEventListener("click", () => updateWeather(true));

      // Clock
      function updateClock() {
        const now = new Date();
        document.getElementById("clock-display").innerText =
          now.toLocaleTimeString("en-US", {
            hour12: false,
            hour: "2-digit",
            minute: "2-digit",
          });
        document.getElementById("date-display").innerText =
          now.toLocaleDateString("en-US", {
            weekday: "short",
            month: "short",
            day: "numeric",
          });

        const hour = now.getHours();
        let greet = "system_ready";
        if (hour < 12) greet = "morning_sumeet";
        else if (hour < 18) greet = "afternoon_sumeet";
        else greet = "evening_sumeet";
        document.getElementById("greeting").innerText = greet;
      }

      // Themes
      function setTheme(name) {
        document.body.className = name === "default" ? "" : "theme-" + name;
        localStorage.setItem("devStartTheme", name);
      }

      // --- COMMAND PARSER ---

      const searchInput = document.getElementById("search-input");

      function handleCommand(cmd, args) {
        switch (cmd) {
          // Help
          case "help":
            toggleHelp();
            return true;

          // Configuration
          case "config":
            if (args[0] === "loc" && args[1] && args[2]) {
              state.location = {
                lat: parseFloat(args[1]),
                lon: parseFloat(args[2]),
              };
              DB.set("devStartLoc", state.location);
              updateWeather(true); // Force refresh on config change
              showToast(`Location set: ${args[1]}, ${args[2]}`);
              return true;
            }
            break;

          // Favourites
          case "fav":
            if (args[0] === "add" && args[1] && args[2]) {
              state.favs.push({ name: args[1], url: args[2] });
              DB.set("devStartFavs", state.favs);
              renderFavourites();
              showToast(`Added favourite: ${args[1]}`);
              return true;
            }
            if (args[0] === "rm" && args[1]) {
              const idx = parseInt(args[1]) - 1;
              if (state.favs[idx]) {
                const removed = state.favs.splice(idx, 1);
                DB.set("devStartFavs", state.favs);
                renderFavourites();
                showToast(`Removed: ${removed[0].name}`);
                return true;
              }
            }
            if (args[0] === "reset") {
              localStorage.removeItem("devStartFavs");
              location.reload();
              return true;
            }
            break;

          // Todos
          case "todo":
            const text = args.join(" ");
            const priority = text.includes("!high") ? "high" : "normal";
            const cleanText = text.replace("!high", "").trim();
            if (cleanText) {
              state.tasks.push({ text: cleanText, priority });
              DB.set("devStartTasks", state.tasks);
              renderTasks();
              showToast("Task added");
              return true;
            }
            break;

          case "done":
            if (args[0]) {
              removeTask(parseInt(args[0]) - 1);
              showToast("Task completed");
              return true;
            }
            break;

          case "clear":
            state.tasks = [];
            DB.set("devStartTasks", state.tasks);
            renderTasks();
            showToast("All tasks cleared");
            return true;
        }
        return false; // Not a command, proceed to search
      }

      searchInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          const val = searchInput.value.trim();
          if (!val) return;

          const parts = val.split(" ");
          const cmd = parts[0].toLowerCase();
          const args = parts.slice(1);

          // Try to execute internal command
          if (handleCommand(cmd, args)) {
            searchInput.value = "";
            return;
          }

          // If not internal, search
          let url = `https://www.google.com/search?q=${encodeURIComponent(
            val
          )}`;
          // Simple shortcuts
          if (cmd === "g")
            url = `https://www.google.com/search?q=${encodeURIComponent(
              args.join(" ")
            )}`;
          if (cmd === "gh")
            url = `https://github.com/search?q=${encodeURIComponent(
              args.join(" ")
            )}`;
          if (cmd === "npm")
            url = `https://www.npmjs.com/search?q=${encodeURIComponent(
              args.join(" ")
            )}`;
          if (cmd === "d")
            url = `https://duckduckgo.com/?q=${encodeURIComponent(
              args.join(" ")
            )}`;
          if (cmd === "p")
            url = `https://pypi.org/search/?q=${encodeURIComponent(
              args.join(" ")
            )}`;
          if (cmd === "aur")
            url = `https://aur.archlinux.org/packages?K=${encodeURIComponent(
              args.join(" ")
            )}`;
          if (cmd === "so")
            url = `https://stackoverflow.com/search?q=${encodeURIComponent(
              args.join(" ")
            )}`;
          if (cmd === "yt")
            url = `https://www.youtube.com/results?search_query=${encodeURIComponent(
              args.join(" ")
            )}`;

          window.location.href = url;
        }
      });

      // Keyboard Shortcuts
      document.addEventListener("keydown", (e) => {
        // Escape to close help
        if (e.key === "Escape") {
          const overlay = document.getElementById("help-overlay");
          if (!overlay.classList.contains("hidden")) {
            toggleHelp();
          }
          return;
        }

        if (document.activeElement === searchInput) return;

        if (e.key === "/") {
          e.preventDefault();
          searchInput.focus();
        }

        // Fav Hotkeys 1-4
        if (["1", "2", "3", "4"].includes(e.key)) {
          const idx = parseInt(e.key) - 1;
          if (state.favs[idx]) window.location.href = state.favs[idx].url;
        }
      });

      // Init
      setTheme(state.theme);
      renderFavourites();
      renderCategoryList("dev-list", state.dev);
      renderCategoryList("docs-list", state.docs);
      renderCategoryList("tools-list", state.tools);
      renderTasks();
      updateClock();
      setInterval(updateClock, 1000);
      updateWeather();
    </script>
  </body>
</html>
